# AutoSigner
Утилита для автоматической обработки и подписания файлов в папках и подпапках
Служит для упрощения процесса подписания отсоединённой подписью и дальнейшей отправки файлов по каналам ViPNet, используя автопроцессинг ViPNet "Деловая почта".

Проблемы, которые решает данный проект:
- отправка автопроцессингом нескольких файлов (автоархивация)
- подписание каждого файла цифровой подписью определённого человека (в зависимости от папки нахождения)
- упрощение обработки большого количества файлов

Основное использование - запуск по графику на определённой папке примерно такой структуры:
- users
	-   Иванова А
	-   Петров Б

После запуска утилита собирает все найдённые по маске файлы и, в зависимости от конфигурации, либо подписывает каждый по одному, либо в начале архивирует и подписывает архив.

Выбор подписи зависит от папки, в которой находился файл.
Соответствие папок и ключей для поиска подписи настраивается.

<br/>

## Конфигурация
|||
| ------------ | ------------ |
| SourceDirectory | исходная папка для обработки |
| DestinationDirectory | папка назначения |
| SearchPattern | маска поиска *(по умолчанию `*`)* |
| FilesMode | метод обработки файлов: <ul><li>**single** *(по одному файлу)*</li><li>**all** *(всё вместе, предварительно заархивировав)*</li></ul>|
| SubfoldersMode | метод обработки подпапок: <ul><li>**pack** *(заархивировать всю папку перед подписанием)*</li><li>**parse** *(обработать содержимое как обычно)*</li><li>**skip** *(не обрабатывать подпапки)*</li></ul> |
| Signer | скрипт подписания |
| PreProcessor | скрипт, вызываемый ДО начала |
| PostProcessor | скрипт, вызываемый ПОСЛЕ окончания |
| ExternalArchiver | внешний архиватор *(если не указан, то используется встроенный .zip)* |
| FolderKeyMap | таблица соответствий подпапок ключам поиска |
| LogFile | путь к папке для хранения логов *(если не указан, лог не ведётся)* |


#### SourceDirectory
Путь до папки, в которой хранятся подпапки пользователей.

#### DestinationDirectory
Путь до папки, в которую необходимо помещать результаты.

#### SearchPattern
Регулярное выражение, используемое как маска для выбора файлов. Если не указано, то по умолчанию выбираются все файлы.

#### FilesMode
Метод обработки файлов, найденных по маске. При использовании `single` каждый файл обрабатывается отдельно. В случае если указать `all`, то все найденные файлы в начале архивируются, а затем полученный архив уже отправляется в обработку.

#### SubfoldersMode
Метод обработки подпапок. При использовании `pack` найденные подпапки в начале архивируются, затем полученный архив расценивается как найденный файл, прошедший проверку по маске и обрабатывается согласно `FilesMode`. Если указать `parse`, то всё содержимое подпапки и всех вложенных подпапок обрабатывается как обычные файлы согласно `FilesMode`. При указании `skip` подпапки исключаются из обработки.

#### Signer
Путь к скрипту подписания.

#### PreProcessor
Путь к скрипту, вызываемому ДО начала обработки полученных файлов. В случае, если скрипту необходимо создать новый файл, который надо обрабатывать, то перед закрытием путь к этому файлу должен быть последней строчкой вывода в консоль. AutoSigner проверит существование этого файла и если он есть, то будет использовать его дальше.

#### PostProcessor
Путь к скрипту, вызываемому ПОСЛЕ окончания обработки полученных файлов. Это финальная стадия, после которой AutoSigner уже не выполняет никаких операций.

#### ExternalArchiver
Путь к скрипту внешнего архиватора. Если не указан, то будет использован встроенный в AutoSigner архиватор Zip в режиме максимального сжатия.

#### FolderKeyMap
Таблица соответствий имён подпапок ключам для поиска электронной подписи, которые передаются в скрипт подписания.

#### LogFile
Путь к папку, в которую помещаются логи действий. Каждый лог файл создаётся с меткой текущей даты. Если параметр не указан, то логи не фиксируются. Так же поддерживаются макросы переменных окружения (%TMP%, %APPDATA% и т.п.)

<br/>

## Командная строка
При указании путей для скриптов необходимо указывать набор параметров для передачи. Поддерживаются следующие макросы для подстановки:
|||
| ------------ | ------------ |
| %SRC% | полный путь до исходного файла |
| %DST% | полный путь до конечной папки |
| %KEY% | ключ для поиска |


Если в параметрах встречается любой из указанных макросов, он заменяется в соответствии со своим значением.

<br/>

Например:

`"Signer": "super_signer.exe -param1 -param2 -name %SRC% -out %DST% -key %KEY%"`

При использовании скрипта будет запущена команда:

`super_signer.exe -param1 -param2 -name "c:\users\Иванова А\документ.docx" -out "\\server\vipnet" -key ivanova_a@mail.ru`

<br/>

## Результаты обработки
В случае успешной обработки всей цепочки, утилита возвращает `0`. Если же в процессе возникает какая-либо ошибка, то возвращается `1` и текст ошибки.
